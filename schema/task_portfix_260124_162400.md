# Task: 改进 scripts/clean-port.js 和 scripts/dev-reload.js 的硬编码端口问题

**任务ID**: task_portfix_260124_162400
**创建时间**: 2026-01-24
**状态**: 进行中
**目标**: 改进两个脚本中硬编码端口的问题，使其更灵活可配置

## 最终目标

1. 分析 `scripts/clean-port.js` 和 `scripts/dev-reload.js` 的当前实现
2. 识别硬编码端口的使用方式
3. 设计改进方案：支持环境变量、配置文件或命令行参数
4. 实现改进，确保向后兼容
5. 更新相关文档和脚本使用说明

## 拆解步骤

### 1. 分析现有脚本

- [ ] 读取并分析 `scripts/clean-port.js`
- [ ] 读取并分析 `scripts/dev-reload.js`
- [ ] 理解它们的用途和端口使用方式
- [ ] 检查是否有其他相关脚本或配置文件

### 2. 设计方案

- [ ] 确定端口配置策略：环境变量 vs 配置文件 vs 命令行参数
- [ ] 考虑向后兼容性
- [ ] 确定默认端口行为
- [ ] 设计配置加载逻辑

### 3. 实现改进

- [ ] 修改 `scripts/clean-port.js`
- [ ] 修改 `scripts/dev-reload.js`
- [ ] 添加必要的配置支持
- [ ] 确保脚本功能不变

### 4. 测试验证

- [ ] 测试修改后的脚本功能
- [ ] 验证端口配置是否生效
- [ ] 检查向后兼容性

### 5. 文档更新

- [ ] 更新 `production.md` 中的相关信息
- [ ] 如有需要，更新 README 或使用说明

## 当前进度

### 已完成: 步骤1 - 分析现有脚本

已分析所有相关脚本，发现硬编码端口位置：

1. **scripts/clean-port.js**: 第10行 `const PORT = 5000;`
2. **scripts/dev-reload.js**: 第15行 `window.location.port === '5000'` (开发模式启用条件)
3. **scripts/smart-restart.js**: 第16行 `port: 5000` (配置对象中，但未使用)
4. **src/server.tsx**: 第78行 `port: 5000` (服务器端口配置)

### 已完成: 步骤3 - 实现改进

**实现改进**：

1. **创建共享配置模块**：
   - 创建 `scripts/shared-config.js`
   - 提供 `getPort()` 函数统一获取端口配置
   - 支持环境变量 `PORT`，默认值 `5000`

2. **修改文件使用共享配置**：
   - **src/server.tsx**: 导入 `getPort` 函数，使用共享配置
   - **scripts/clean-port.js**: 导入 `getPort` 函数，移除本地实现
   - **scripts/dev-reload.js**: 移除硬编码端口检查 `window.location.port === '5000'`
     - 保留本地主机名检查（localhost、127.0.0.1、.local）
     - 允许在任何本地端口启用开发刷新
   - **scripts/smart-restart.js**: 导入 `getPort` 函数，更新 `CONFIG.port`

3. **关键设计决策**：
   - 使用共享配置模块避免代码重复
   - 所有端口配置统一从环境变量 `PORT` 获取
   - 默认值 `5000` 确保向后兼容
   - `dev-reload.js` 作为客户端脚本，使用 `window.location.origin` 自动获取当前URL

### 已完成: 步骤4 - 测试验证

**测试结果**：
- ✅ `scripts/clean-port.js` 正常运行（默认端口5000）
- ✅ `scripts/clean-port.js` 支持环境变量 `PORT=3000`
- ✅ 共享配置模块 `shared-config.js` 正常工作
- ✅ 所有文件导入无语法错误
- ✅ `smart-restart.js` 成功导入共享配置

### 已完成: 步骤5 - 文档更新

**文档更新**：
- ✅ 在 `production.md` 中添加"端口配置"章节
- ✅ 说明配置方式：环境变量 `PORT`，默认值 `5000`
- ✅ 列出相关脚本和向后兼容性说明

## 任务完成总结

已成功改进 `scripts/clean-port.js` 和 `scripts/dev-reload.js` 的硬编码端口问题：

1. **创建共享配置系统**：
   - 新增 `scripts/shared-config.js` 提供统一的 `getPort()` 函数
   - 支持环境变量 `PORT` 配置，默认值 `5000`

2. **统一端口配置**：
   - `src/server.tsx`: 使用共享配置获取端口
   - `scripts/clean-port.js`: 使用共享配置，支持环境变量
   - `scripts/dev-reload.js`: 移除硬编码端口检查，支持任何本地端口
   - `scripts/smart-restart.js`: 更新配置使用共享端口

3. **改进效果**：
   - 消除了硬编码端口依赖
   - 支持灵活端口配置
   - 保持向后兼容性
   - 所有相关脚本使用统一配置源

**状态**: 已完成 ✅

## 下一步行动

1. 确定端口配置策略细节
2. 设计配置加载逻辑
3. 开始修改脚本